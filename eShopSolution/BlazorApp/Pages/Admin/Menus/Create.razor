@page "/admin/menus/create"
@using BlazorApp.Interfaces
@using BlazorApp.Models.Menus
@inject IApiClient ApiClient
@inject NavigationManager NavigationManager

<h3>Create Menu</h3>
<hr />

<EditForm Model="@Menu" OnValidSubmit="HandleValidSubmit">
    <!-- *** KEY CHANGE: Use DataAnnotationsValidator *** -->
    <DataAnnotationsValidator />

    <ValidationSummary />

    <!-- Title -->
    <div class="mb-3">
        <label class="form-label">Menu Title:</label>
        <InputText class="form-control" @bind-Value="Menu.MenuTitle" />
        <ValidationMessage For="@(() => Menu.MenuTitle)" />
    </div>

    <!-- Link -->
    <div class="mb-3">
        <label class="form-label">Link:</label>
        <InputText class="form-control" @bind-Value="Menu.Link" />
        <ValidationMessage For="@(() => Menu.Link)" />
    </div>

    <!-- Type -->
    <div class="mb-3">
        <label class="form-label">Type:</label>
        <InputSelect class="form-control" @bind-Value="Menu.Type" @bind-Value:after="OnTypeChanged">
            <option value="">-- Select Type --</option>
            <option value="Top">Top</option>
            <option value="Bottom">Bottom</option>
        </InputSelect>
        <ValidationMessage For="@(() => Menu.Type)" />
    </div>

    <!-- ParentId -->
    <div class="mb-3">
        <label class="form-label">Parent Menu:</label>
        <InputSelect class="form-control" @bind-Value="Menu.ParentId" disabled="@isParentMenuDisabled">
            <option value="">-- No Parent --</option>
            @if (ParentMenus != null)
            {
                @foreach (var p in ParentMenus)
                {
                    <option value="@p.Id.ToString()">@p.Title</option>
                }
            }
        </InputSelect>
        <ValidationMessage For="@(() => Menu.ParentId)" />
    </div>

    <!-- Order -->
    <div class="mb-3">
        <label class="form-label">Order:</label>
        <InputNumber class="form-control" @bind-Value="Menu.Order" />
        <ValidationMessage For="@(() => Menu.Order)" />
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
</EditForm>

@code {
    // *** BEST PRACTICE: Initialize the model to prevent NullReferenceException ***
    private MenuDto Menu { get; set; } = new();
    private List<MenuLookupModel> ParentMenus = new();
    private bool isParentMenuDisabled = true;

    protected override async Task OnInitializedAsync()
    {
        // No initial load needed, wait for user to select a type.
    }

    private async Task OnTypeChanged()
    {
        Menu.ParentId = null;
        ParentMenus.Clear();
        isParentMenuDisabled = string.IsNullOrWhiteSpace(Menu.Type);

        if (!isParentMenuDisabled)
        {
            await LoadParentMenus(Menu.Type);
        }
    }

    private async Task LoadParentMenus(string type)
    {
        try
        {
            var response = await ApiClient.GetAsync<List<MenuLookupModel>>($"v1/menus/for-list?type={type}");

            if (response.IsSuccessful && response.Data != null)
            {
                ParentMenus = response.Data;
            }
            else
            {
                Console.WriteLine($"Error loading parent menus: {response.Messages}");
                ParentMenus = new List<MenuLookupModel>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception loading parent menus: {ex.Message}");
            ParentMenus = new List<MenuLookupModel>();
        }
    }

    private async Task HandleValidSubmit()
    {
        Console.WriteLine("Form is valid. Submitting...");
        Console.WriteLine($"Title: {Menu.MenuTitle}, Link: {Menu.Link}, Type: {Menu.Type}");

        // --- Your API call to create the menu would go here ---
        // var createResponse = await ApiClient.PostAsync<MenuDto>("menus", Menu);
        // if (createResponse.IsSuccessful)
        // {
        //     NavigationManager.NavigateTo("/admin/menus");
        // }
    }
}